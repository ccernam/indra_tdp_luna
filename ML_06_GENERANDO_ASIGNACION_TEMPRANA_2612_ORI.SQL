

USE COBRA

/****************************************************************************************************************************************/
PRINT '/**********  INICIO DE SCRIPT 06_GENERANDO_ASIGNACION_TEMPRANA  **********\'
PRINT 'HORA INICIO: ' + cast(cast(getdate() as dateTIME) as varchar(20))
/****************************************************************************************************************************************/

----  select * from SRMS.DBO.JAS_BASE_SERVICIOS_LUNA_ASIGNACIONX
---- ASIGNACION TEMPRANA ---- 
----- BACKUP
  
 
If OBJECT_ID('TEMP_LUNA') Is Not Null Drop table TEMP_LUNA
If OBJECT_ID('Luna_dis_hdec') Is Not Null Drop table Luna_dis_hdec
If OBJECT_ID('Luna_dis_fastcob') Is Not Null Drop table Luna_dis_fastcob
If OBJECT_ID('SRMS.DBO.JAS_UNIVERSO_TEMPRANA') Is Not Null Drop table SRMS.DBO.JAS_UNIVERSO_TEMPRANA
If OBJECT_ID('srms.dbo.JAS_MASTER_AGENCIA_ASIGNADA_BK_LUNA') Is Not Null Drop table srms.dbo.JAS_MASTER_AGENCIA_ASIGNADA_BK_LUNA

--Drop table TEMP_LUNA
--Drop table #JAS_UNIVERSO_TEMPRANA
--Drop table #JAS_AGENCIAS_TEMPRANA_INI_0
--Drop table Luna_dis_hdec
--Drop table Luna_dis_fastcob
--Drop table SRMS.DBO.JAS_UNIVERSO_TEMPRANA
--Drop table  srms.dbo.JAS_MASTER_AGENCIA_ASIGNADA_BK_LUNA


select * into srms.dbo.JAS_MASTER_AGENCIA_ASIGNADA_BK_LUNA from cobra.LUNA.MASTER_AGENCIA_ASIGNADA

--- SELECT COD_AGENCIA,COUNT(1) FROM cobra.LUNA.MASTER_AGENCIA_ASIGNADA WHERE COD_GESTION=1 GROUP BY COD_AGENCIA

---SELECT * INTO srms.dbo.JAS_MASTER_AGENCIA_ASIGNADA_BK_LUNAX_16022018 FROM cobra.LUNA.MASTER_AGENCIA_ASIGNADA

--SELECT A.COD_AGENCIA,B.NOMBRE,COUNT(1) FROM cobra.LUNA.MASTER_AGENCIA_ASIGNADA A
--JOIN COBRA.LUNA.CORE_AGENCIA B ON A.COD_AGENCIA=B.COD_AGENCIA
-- WHERE A.COD_GESTION=1
--GROUP BY A.COD_AGENCIA,B.NOMBRE

-----SELECT * FROM COBRA.LUNA.CORE_AGENCIA

---- LUNA TEMPRANA UNIVERSO ----
--SELECT COD_LUNA,COD_CONVERGENCIA,COD_SCORE_CONVERGENTE,ISNULL(COD_RANGO_DEUDA_TEMPRANA,0) COD_RANGO_DEUDA_TEMPRANA,  FROM SRMS.DBO.JAS_BASE_SERVICIOS_LUNA_ASIGNACIONX
--WHERE MARCA_FECHA_BAJA=0 OR (MARCA_FECHA_BAJA BETWEEN 1 AND 12 AND FLAG_DEUDA=1)  --- BASE FINAL A DISTRIBUIR ---

----------------- INCLUYENDO MARCAS PARA ASIGNACION ---
------- 
 

 
SELECT * INTO #JAS_UNIVERSO_TEMPRANA  FROM SRMS.DBO.JAS_BASE_SERVICIOS_LUNA_ASIGNACION
WHERE MARCA_FECHA_BAJA=0 OR (MARCA_FECHA_BAJA BETWEEN 1 AND 6 AND FLAG_DEUDA=1)  --- BASE FINAL A DISTRIBUIR ---
 
 
Declare @Sql NVARCHAR(2000)
SET @sql = ' ALTER TABLE   #JAS_UNIVERSO_TEMPRANA ADD COD_AGENCIA_TEMPRANA TINYINT '       
PRINT @sql                                
EXECUTE SP_EXECUTESQL @sql

 

---- ASIGNANDO HDEC PREMIUM ----395,626
UPDATE #JAS_UNIVERSO_TEMPRANA
SET COD_AGENCIA_TEMPRANA= 14
WHERE COD_SEGMENTO=4
AND COD_AGENCIA_TEMPRANA IS NULL


SELECT DISTINCT COD_LUNA INTO TEMP_LUNA FROM #JAS_UNIVERSO_TEMPRANA WHERE COD_AGENCIA_TEMPRANA= 14

UPDATE #JAS_UNIVERSO_TEMPRANA SET 
COD_AGENCIA_TEMPRANA= 14
FROM #JAS_UNIVERSO_TEMPRANA A INNER JOIN TEMP_LUNA B
ON A.COD_LUNA=B.COD_LUNA

---- DETERMINANDO FINANCIAMIENTO ----(HDEC)   
 

UPDATE  #JAS_UNIVERSO_TEMPRANA     ---1,183,805
SET COD_AGENCIA_TEMPRANA = 1  
FROM #JAS_UNIVERSO_TEMPRANA
WHERE MARCA_FINAN=1
AND COD_AGENCIA_TEMPRANA IS NULL


If OBJECT_ID('TEMP_LUNA') Is Not Null Drop table TEMP_LUNA
 
SELECT DISTINCT COD_LUNA INTO TEMP_LUNA FROM #JAS_UNIVERSO_TEMPRANA WHERE COD_AGENCIA_TEMPRANA = 1

UPDATE #JAS_UNIVERSO_TEMPRANA SET 
COD_AGENCIA_TEMPRANA= 1
FROM #JAS_UNIVERSO_TEMPRANA A INNER JOIN TEMP_LUNA B
ON A.COD_LUNA=B.COD_LUNA


---- DETERMINANDO MT ---- --(FASTCO) ---262,618

UPDATE #JAS_UNIVERSO_TEMPRANA
SET COD_AGENCIA_TEMPRANA = 22  
FROM #JAS_UNIVERSO_TEMPRANA
WHERE MARCA_MT=1
AND COD_AGENCIA_TEMPRANA IS NULL


If OBJECT_ID('TEMP_LUNA') Is Not Null Drop table TEMP_LUNA
SELECT DISTINCT COD_LUNA INTO TEMP_LUNA FROM #JAS_UNIVERSO_TEMPRANA WHERE COD_AGENCIA_TEMPRANA = 22    

UPDATE #JAS_UNIVERSO_TEMPRANA SET 
COD_AGENCIA_TEMPRANA= 22
FROM #JAS_UNIVERSO_TEMPRANA A INNER JOIN TEMP_LUNA B
ON A.COD_LUNA=B.COD_LUNA

---- DETERMINANDO OPERACIONES ----

UPDATE #JAS_UNIVERSO_TEMPRANA
SET COD_AGENCIA_TEMPRANA = 15 
FROM #JAS_UNIVERSO_TEMPRANA
WHERE MARCA_BASE_CARIBU=1
AND COD_AGENCIA_TEMPRANA IS NULL


If OBJECT_ID('TEMP_LUNA') Is Not Null Drop table TEMP_LUNA
SELECT DISTINCT COD_LUNA INTO TEMP_LUNA FROM #JAS_UNIVERSO_TEMPRANA WHERE COD_AGENCIA_TEMPRANA = 15    

UPDATE #JAS_UNIVERSO_TEMPRANA SET 
COD_AGENCIA_TEMPRANA= 15
FROM #JAS_UNIVERSO_TEMPRANA A INNER JOIN TEMP_LUNA B
ON A.COD_LUNA=B.COD_LUNA

----------------------------------------------- SE VA COMENTAR PORQUE NO HAY ASIGNACION POR ALTAS ------------------------------
---- DETERMINANDO ATENTO 
/*
DROP TABLE #JAS_BASE_ATENTO
SELECT DISTINCT COD_LUNA INTO #JAS_BASE_ATENTO FROM #JAS_UNIVERSO_TEMPRANA
WHERE MARCA_BASE_ATENTO=1 
AND COD_LUNA NOT IN 
(
SELECT COD_LUNA FROM #JAS_UNIVERSO_TEMPRANA WHERE MARCA_BASE_ATENTO=1  AND (FLAG_CARIBU=1 OR MARCA_FECHA_BAJA>0 ) AND COD_AGENCIA_TEMPRANA IS NULL
)
AND COD_AGENCIA_TEMPRANA IS NULL

/*
UPDATE #JAS_UNIVERSO_TEMPRANA
SET COD_AGENCIA_TEMPRANA=5
FROM #JAS_UNIVERSO_TEMPRANA A
JOIN #JAS_BASE_ATENTO B
ON A.COD_LUNA=B.COD_LUNA
WHERE A.COD_AGENCIA_TEMPRANA IS NULL
*/
UPDATE #JAS_UNIVERSO_TEMPRANA
---SET COD_AGENCIA_TEMPRANA=5
SET COD_AGENCIA_TEMPRANA=NULL
FROM #JAS_UNIVERSO_TEMPRANA A
JOIN #JAS_BASE_ATENTO B
ON A.COD_LUNA=B.COD_LUNA
WHERE A.COD_AGENCIA_TEMPRANA IS NULL
AND 1=2 ----- PARA QUE NO ACTUALICE NADA (NO SE ENVÍA NADA A ATENTO) 
*/
----------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------- AGENCIAS FASTCO, ATENTO Y HDEC -----------------------------------------------
 
--Declare @Sql NVARCHAR(2000)
If OBJECT_ID('#JAS_AGENCIAS_TEMPRANA_INI_0') Is Not Null Drop table #JAS_AGENCIAS_TEMPRANA_INI_0

SELECT DISTINCT COD_LUNA,COD_CONVERGENCIA,COD_SCORE_CONVERGENTE,ISNULL(COD_RANGO_DEUDA_TEMPRANA,0) COD_RANGO_DEUDA_TEMPRANA
INTO #JAS_AGENCIAS_TEMPRANA_INI_0
FROM #JAS_UNIVERSO_TEMPRANA WHERE COD_AGENCIA_TEMPRANA IS NULL
 
 declare @base int
 declare @nulo int
 declare @hdec int
 declare @atento int
 declare @fastcob int

 declare @totalHdec numeric(9,2)
 declare @totalfastcob numeric(9,2)
 declare @totalnulo numeric(9,2)
 
 declare @HdecP numeric(9,2)
 declare @fastcobP numeric(9,2)
 declare @nuloP numeric(9,2)
 
 declare @HdecPf numeric(9,2)
 declare @fastcobPf numeric(9,2)
 declare @nuloPf numeric(9,2)

 declare @HdecPft int
 declare @fastcobPft int
 declare @nuloPft int
  

 set @hdec= (select count (distinct cod_luna) from  #JAS_UNIVERSO_TEMPRANA where COD_AGENCIA_TEMPRANA=1)					    --1,045,603 
 set @nulo= (select count (distinct cod_luna) from  #JAS_UNIVERSO_TEMPRANA where COD_AGENCIA_TEMPRANA is null)					--5,631,104
 set @fastcob=(select  count (distinct cod_luna) from  #JAS_UNIVERSO_TEMPRANA where COD_AGENCIA_TEMPRANA=22)					--  87,111
 
 --select @hdec
 --select @nulo
 --select @fastcob

 set @base= @hdec+ @nulo +@fastcob																								--7,303,829
 set @totalHdec=(cast(@hdec as float)/cast(@base as float))																		--0.15
 set @totalfastcob=(cast(@fastcob as float)/cast(@base as float)) 																--0.01
 set @totalnulo=(cast(@nulo as float)/cast(@base as float))																		--0.83
  
 --select @base
 --select @totalHdec
 --select @totalfastcob
 -----select @totalnulo


 set @HdecP=0.30
 set @fastcobP=0.37
 set @nuloP=0.33

 
 set @HdecPf = @HdecP - @totalHdec
 set @fastcobPf =@fastcobP - @totalfastcob
 set @nuloPf = @nuloP  
 
  --SELECT @HdecPf      
  --SELECT @fastcobPf   
  --SELECT @nuloPf 

 set @HdecPft  = (select count (distinct cod_luna) from  #JAS_UNIVERSO_TEMPRANA WHERE ISNULL(COD_AGENCIA_TEMPRANA,0) NOT IN (14,15))*@HdecPf
 set @fastcobPft = (select count (distinct cod_luna) from  #JAS_UNIVERSO_TEMPRANA WHERE ISNULL(COD_AGENCIA_TEMPRANA,0) NOT IN (14,15))*@fastcobPf
 set @nuloPft = (select count (distinct cod_luna) from  #JAS_UNIVERSO_TEMPRANA WHERE ISNULL(COD_AGENCIA_TEMPRANA,0) NOT IN (14,15))*@nuloPf


 --select @HdecPft
 --select @fastcobPft
 --select @nuloPft
 
 
 

--If OBJECT_ID('Luna_dis_hdec') Is Not Null Drop table Luna_dis_hdec
 If OBJECT_ID('Luna_dis_fastcob') Is Not Null Drop table Luna_dis_fastcob
 

--SET @sql = ' select top '+cast(@HdecPft as char(10))+' cod_luna into Luna_dis_hdec from #JAS_AGENCIAS_TEMPRANA_INI_0 '                                      
--EXECUTE SP_EXECUTESQL @sql
--PRINT @sql 

SET @sql = ' select top '+cast(@fastcobPft as char(10))+' cod_luna into Luna_dis_fastcob from #JAS_AGENCIAS_TEMPRANA_INI_0 '                                      
EXECUTE SP_EXECUTESQL @sql
PRINT @sql 
 
 
SET @sql = ' ALTER TABLE   #JAS_AGENCIAS_TEMPRANA_INI_0 ADD COD_AGENCIA TINYINT '                                      
EXECUTE SP_EXECUTESQL @sql
PRINT @sql 

update #JAS_AGENCIAS_TEMPRANA_INI_0 set
COD_AGENCIA=22
from #JAS_AGENCIAS_TEMPRANA_INI_0 a inner join Luna_dis_fastcob b
on a.cod_luna=b.cod_luna

If OBJECT_ID('Luna_dis_ATE') Is Not Null Drop table Luna_dis_ATE

SET @sql = ' select top '+cast(@nuloPft as char(10))+' cod_luna into Luna_dis_ATE from #JAS_AGENCIAS_TEMPRANA_INI_0 where COD_AGENCIA is null '                                      
EXECUTE SP_EXECUTESQL @sql
PRINT @sql 
 
update #JAS_AGENCIAS_TEMPRANA_INI_0 set
COD_AGENCIA=5
from #JAS_AGENCIAS_TEMPRANA_INI_0 a inner join Luna_dis_ATE b
on a.cod_luna=b.cod_luna

--SELECT  COD_AGENCIA,count(distinct cod_luna) FROM #JAS_AGENCIAS_TEMPRANA_INI_0 GROUP BY COD_AGENCIA 

update #JAS_AGENCIAS_TEMPRANA_INI_0 set
COD_AGENCIA=1
where COD_AGENCIA is null

------------------------------------ VALIDAR ---------------------------------

--select COD_CONVERGENCIA,COD_SCORE_CONVERGENTE,COD_RANGO_DEUDA_TEMPRANA,COD_AGENCIA, count(DISTINCT COD_LUNA)
-- from  #JAS_AGENCIAS_TEMPRANA_INI_0
-- group by COD_CONVERGENCIA,COD_SCORE_CONVERGENTE,COD_RANGO_DEUDA_TEMPRANA,COD_AGENCIA

 /*

-----------------  AGENCIA ANTERIOR  -----
DROP TABLE #JAS_AGENCIA_TEM_ANTERIOR
SELECT DISTINCT COD_LUNA,COD_AGENCIA
INTO #JAS_AGENCIA_TEM_ANTERIOR 
FROM srms.dbo.JAS_MASTER_AGENCIA_ASIGNADA_BK_LUNAX 
WHERE COD_GESTION=1 ---- GESTION TEMPRANA
AND COD_AGENCIA IN (1,12)  --- AGENCIAS 1,12

ALTER TABLE #JAS_AGENCIAS_TEMPRANA_INI_0 ADD MARCA_ASIGNACION_ATERIOR TINYINT

UPDATE #JAS_AGENCIAS_TEMPRANA_INI_0
SET MARCA_ASIGNACION_ATERIOR=1
FROM #JAS_AGENCIAS_TEMPRANA_INI_0 A
JOIN #JAS_AGENCIA_TEM_ANTERIOR B ON A.COD_LUNA=B.COD_LUNA

--- CUENTAS A DISTRIBUIR ----
DROP TABLE #JAS_AGENCIAS_TEMPRANA
SELECT COD_LUNA,COD_CONVERGENCIA,COD_SCORE_CONVERGENTE,COD_RANGO_DEUDA_TEMPRANA 
INTO #JAS_AGENCIAS_TEMPRANA
FROM #JAS_AGENCIAS_TEMPRANA_INI_0 WHERE MARCA_ASIGNACION_ATERIOR IS NULL

---- #JAS_AGENCIAS_TEMPRANA 


ALTER TABLE #JAS_AGENCIAS_TEMPRANA ADD COD_AGENCIA_ANTERIOR TINYINT

UPDATE #JAS_AGENCIAS_TEMPRANA
SET COD_AGENCIA_ANTERIOR=B.COD_AGENCIA
FROM #JAS_AGENCIAS_TEMPRANA A
JOIN #JAS_AGENCIA_TEM_ANTERIOR B
ON A.COD_LUNA=B.COD_LUNA

SELECT *,ROW_NUMBER() OVER(PARTITION BY COD_CONVERGENCIA,COD_SCORE_CONVERGENTE,COD_RANGO_DEUDA_TEMPRANA ORDER BY ISNULL(COD_AGENCIA_ANTERIOR,4)) ORDEN
INTO #JAS_AGENCIAS_TEMPRANA_2
 FROM #JAS_AGENCIAS_TEMPRANA 

ALTER TABLE #JAS_AGENCIAS_TEMPRANA_2 ADD COD_AGENCIA_TEMPRANA TINYINT

update #JAS_AGENCIAS_TEMPRANA_2
set COD_AGENCIA_TEMPRANA=case when a.orden<=b.ctd_mitad then b.min_cod_agencia else b.max_cod_agencia end 
from #JAS_AGENCIAS_TEMPRANA_2 a
join (select COD_CONVERGENCIA,COD_SCORE_CONVERGENTE,COD_RANGO_DEUDA_TEMPRANA,count(1)ctd,count(1)/2 ctd_mitad,min(ISNULL(COD_AGENCIA_ANTERIOR,1)) min_cod_agencia,max(ISNULL(COD_AGENCIA_ANTERIOR,12)) max_cod_agencia 
from #JAS_AGENCIAS_TEMPRANA_2 group by COD_CONVERGENCIA,COD_SCORE_CONVERGENTE,COD_RANGO_DEUDA_TEMPRANA) b
on a.COD_CONVERGENCIA=b.COD_CONVERGENCIA and a.COD_SCORE_CONVERGENTE=b.COD_SCORE_CONVERGENTE AND A.COD_RANGO_DEUDA_TEMPRANA=B.COD_RANGO_DEUDA_TEMPRANA
-- where a.orden<=b.ctd_mitad


UPDATE #JAS_UNIVERSO_TEMPRANA
SET COD_AGENCIA_TEMPRANA=B.COD_AGENCIA_TEMPRANA
FROM #JAS_UNIVERSO_TEMPRANA A
JOIN #JAS_AGENCIAS_TEMPRANA_2 B
ON A.COD_LUNA=B.COD_LUNA
WHERE A.COD_AGENCIA_TEMPRANA IS NULL

----- MARCANDO EL UNIVERSO DE TEMPRANA -----
---SELECT * FROM srms.dbo.JAS_MASTER_AGENCIA_ASIGNADA_BK_LUNAX
DROP TABLE #JAS_ASIGNACION_ANTERIOR_LUNA
SELECT * INTO #JAS_ASIGNACION_ANTERIOR_LUNA FROM srms.dbo.JAS_MASTER_AGENCIA_ASIGNADA_BK_LUNAX 
WHERE COD_GESTION=1 ---- GESTION TEMPRANA 

ALTER TABLE #JAS_UNIVERSO_TEMPRANA ADD FECHA_ASIGNACION DATE,MARCA_ASIGNACION BIT

UPDATE #JAS_UNIVERSO_TEMPRANA
SET 
COD_AGENCIA_TEMPRANA=B.COD_AGENCIA
FROM #JAS_UNIVERSO_TEMPRANA A
JOIN #JAS_ASIGNACION_ANTERIOR_LUNA B ON A.COD_LUNA=B.COD_LUNA
WHERE A.COD_AGENCIA_TEMPRANA IS NULL

UPDATE #JAS_UNIVERSO_TEMPRANA
SET 
--COD_AGENCIA_TEMPRANA=CASE WHEN B.COD_LUNA IS NOT NULL AND A.COD_AGENCIA_TEMPRANA IS NULL THEN B.COD_AGENCIA ELSE A.COD_AGENCIA_TEMPRANA END ,
FECHA_ASIGNACION=CASE WHEN B.COD_LUNA IS NOT NULL AND ISNULL(A.COD_AGENCIA_TEMPRANA,99)=B.COD_AGENCIA THEN B.FECHA_ASIGNACION ELSE CONVERT(DATE,GETDATE(),121) END ,
MARCA_ASIGNACION=CASE WHEN B.COD_LUNA IS NOT NULL AND ISNULL(A.COD_AGENCIA_TEMPRANA,99)=B.COD_AGENCIA THEN 0 ELSE 1 END
FROM #JAS_UNIVERSO_TEMPRANA A
LEFT JOIN #JAS_ASIGNACION_ANTERIOR_LUNA B ON A.COD_LUNA=B.COD_LUNA


--SELECT COD_CONVERGENCIA,COD_SCORE_CONVERGENTE,COD_RANGO_DEUDA_TEMPRANA,COD_AGENCIA_TEMPRANA,COUNT(DISTINCT COD_LUNA) CTD FROM #JAS_UNIVERSO_TEMPRANA
--GROUP BY COD_CONVERGENCIA,COD_SCORE_CONVERGENTE,COD_RANGO_DEUDA_TEMPRANA,COD_AGENCIA_TEMPRANA
*/
 

UPDATE #JAS_UNIVERSO_TEMPRANA SET
COD_AGENCIA_TEMPRANA=B.COD_AGENCIA 
FROM #JAS_UNIVERSO_TEMPRANA A INNER JOIN #JAS_AGENCIAS_TEMPRANA_INI_0   B
ON A.COD_LUNA=B.COD_LUNA AND A.COD_AGENCIA_TEMPRANA IS NULL
  
  
SET @sql = ' ALTER TABLE   #JAS_UNIVERSO_TEMPRANA ADD FECHA_ASIGNACION DATE,MARCA_ASIGNACION BIT '                                      
EXECUTE SP_EXECUTESQL @sql
PRINT @sql 

If OBJECT_ID('SRMS.DBO.JAS_UNIVERSO_TEMPRANA') Is Not Null Drop table SRMS.DBO.JAS_UNIVERSO_TEMPRANA
 
SELECT * 
INTO SRMS.DBO.JAS_UNIVERSO_TEMPRANA --10,599,904
FROM #JAS_UNIVERSO_TEMPRANA  ---10,599,904
 
 

/****************************************************************************************************************************************/
PRINT 'HORA FIN: ' + cast(cast(getdate() as dateTIME) as varchar(20))
PRINT '\**********  FIN DE SCRIPT 06_GENERANDO_ASIGNACION_TEMPRANA  **********/'
/****************************************************************************************************************************************/