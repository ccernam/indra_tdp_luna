USE [COBRA]

/****************************************************************************************************************************************/
PRINT '/**********  INICIO DE SCRIPT 05_GENERANDO_TABLON_ASIGNACION  **********\'
PRINT 'HORA INICIO: ' + cast(cast(getdate() as dateTIME) as varchar(20))
/****************************************************************************************************************************************/

--ALTER view [dbo].[view_luna_cliente_cuenta_servicio_jas] as
--select  b.COD_LUNA,b.NOMBRE,b.APELLIDO_PATERNO,b.APELLIDO_MATERNO,b.COD_SEGMENTO,b.COD_RANGO_DEUDA,b.COD_TIPO_IDENTIFICACION,b.NRO_IDENTIFICACION,b.COD_CONVERGENCIA,B.COD_SCORE_CONVERGENTE,Y.COD_RANGO_DEUDA_TEMPRANA,Y.COD_RANGO_DEUDA_AVANZADA,B.FLAG_ACTIVO FLAG_ACTIVO_LUNA,c.COD_SISTEMA,c.COD_CLIENTE,c.COD_CUENTA,d.COD_SERVICIO,d.FECHA_ALTA,d.FECHA_MIGRACION,d.COD_ESTADO,d.FLAG_ACTIVO,c.FLAG_DEUDA,d.TELEFONO
--from 
--cobra.luna.master_Servicio d 
--join cobra.luna.master_cuenta c on c.COD_SISTEMA=d.COD_SISTEMA and c.COD_CLIENTE=d.COD_CLIENTE and c.COD_CUENTA=d.COD_CUENTA
--join cobra.luna.master_cliente a on c.COD_SISTEMA=a.COD_SISTEMA and c.cod_cliente=a.COD_CLIENTE
--join cobra.luna.master_luna b on a.cod_luna=b.cod_luna
--LEFT JOIN COBRA.LUNA.RESUMEN_RANGO_DEUDA_90_JAS Y ON (B.COD_LUNA = Y.COD_LUNA) 
--GO

--------------------- BACKUPEANDO TABLON -------------
DROP TABLE SRMS.DBO.JAS_BASE_SERVICIOS_LUNA_ASIGNACION_BK_MES_ANTERIOR
SELECT * INTO SRMS.DBO.JAS_BASE_SERVICIOS_LUNA_ASIGNACION_BK_MES_ANTERIOR FROM SRMS.DBO.JAS_BASE_SERVICIOS_LUNA_ASIGNACION

--------------------- INICIO -----------------

DROP TABLE #JAS_BASE_SERVICIOS_LUNA
SELECT DISTINCT COD_LUNA,COD_SISTEMA,COD_CLIENTE,COD_CUENTA,COD_SERVICIO ,COD_ESTADO,COD_SEGMENTO,COD_CONVERGENCIA,COD_SCORE_CONVERGENTE,COD_RANGO_DEUDA_TEMPRANA,COD_RANGO_DEUDA_AVANZADA,FECHA_ALTA
INTO #JAS_BASE_SERVICIOS_LUNA
FROM [dbo].[view_luna_cliente_cuenta_servicio_jas] 
WHERE 
COD_SEGMENTO>=4 AND  
(ISNULL(COD_RANGO_DEUDA_TEMPRANA,0) <= 10  OR ISNULL(COD_RANGO_DEUDA_AVANZADA,0) <= 10) AND 
FLAG_ACTIVO_LUNA=1  and  ----- 1.34 MIN
FLAG_ACTIVO=1

---- OBTENIENDO FECHA DE BAJA -----
--- ATIS ---
	DROP TABLE #JAS_LUNA_SERVICIO_ATIS
	SELECT  
		DISTINCT CLIENTE'COD_CLIENTE', CUENTA'COD_CUENTA', PRODUCTO_COMERCIAL'COD_SERVICIO', CAST(Fecha_Baja_PC AS DATE) 'FECHA_BAJA'
		INTO #JAS_LUNA_SERVICIO_ATIS
	FROM ATIS.PLANTA_SERVICIO
	WHERE DES_SUB_TIPO_PC NOT IN ('P43 FONOFACIL','P43 FONOFACIL     FA','P43 FONOFACIL PRX','P43 FONOFACIL PRX FA',
		'P77 FLEX.TEMP. C/ FA','P77 FLEX.TEMP. C/COM','P78 FLEX.TEMP. C/ FA','P78 FLEX.TEMP. C/COM',
		'TPE','TPE               FA','TPE RURAL','TPE RURAL         FA')
AND (CASE DES_Estado_PC 
	WHEN 'ACTIVO' THEN 10 
	WHEN 'SUSPENDIDO' THEN 20 
	WHEN 'BAJA' THEN 30 END)=30

--- CMS --- 

--- SELECT * FROM CMS.PLANTA_SERVICIO   --- no hay data de baja -----

--- STC ---
	DROP TABLE #JAS_LUNA_SERVICIO_STC
	SELECT DISTINCT
		TCCCLI'COD_CLIENTE', TCNAPA'COD_CUENTA', TCNFOL'COD_SERVICIO',CAST(((RTRIM(LOANO) + '-' + RTRIM(LOMES) + '-' + RTRIM(LODIA))) AS DATE) 'FECHA_BAJA'
		INTO #JAS_LUNA_SERVICIO_STC
	FROM STC.PLANTA_SERVICIO AS A
	INNER JOIN STC.CATALOGO_PRODUCTO AS B
	ON (A.TCCPRO = B.TCCPRO AND A.TCCLIP = B.TCCLIP AND A.TCCTSE = B.TCCTSE AND A.TCTICO = B.TCTICO)
	WHERE B.GPDGRU IN ('GRUPO BAM', 'GRUPO CELULAR CONTROL', 'GRUPO CELULAR POSTPAGO') AND ISDATE((RTRIM(TCACON) + '-' + RTRIM(TCMCON) + '-' + RTRIM(TCDCON))) = 1
	AND COD_ESTADO=30 AND ISDATE(RTRIM(LOANO) + '-' + RTRIM(LOMES) + '-' + RTRIM(LODIA))=1


--- AMDOCS --- 
	DROP TABLE #JAS_LUNA_SERVICIO_AMDOCS
	SELECT DISTINCT
		COD_CLIENTE 'COD_CLIENTE', COD_CUENTA 'COD_CUENTA', COD_SERVICIO 'COD_SERVICIO', CAST(FECHA_ESTADO_SUSCRIPTOR AS DATE) 'FECHA_BAJA'
		INTO #JAS_LUNA_SERVICIO_AMDOCS
	FROM AMDOCS.PLANTA_SERVICIO WHERE COD_ESTADO=30

------ MARCANDO FECHA BAJA

ALTER TABLE #JAS_BASE_SERVICIOS_LUNA ADD FECHA_BAJA DATE

UPDATE #JAS_BASE_SERVICIOS_LUNA
SET FECHA_BAJA=B.FECHA_BAJA
FROM 
#JAS_BASE_SERVICIOS_LUNA A
JOIN #JAS_LUNA_SERVICIO_ATIS B ON A.COD_CLIENTE=B.COD_CLIENTE AND A.COD_CUENTA=B.COD_CUENTA AND A.COD_SERVICIO=B.COD_SERVICIO
WHERE A.COD_SISTEMA=1


UPDATE #JAS_BASE_SERVICIOS_LUNA
SET FECHA_BAJA=B.FECHA_BAJA
FROM 
#JAS_BASE_SERVICIOS_LUNA A
JOIN #JAS_LUNA_SERVICIO_STC B ON A.COD_CLIENTE=B.COD_CLIENTE AND A.COD_CUENTA=B.COD_CUENTA AND A.COD_SERVICIO=B.COD_SERVICIO
WHERE A.COD_SISTEMA=3


UPDATE #JAS_BASE_SERVICIOS_LUNA
SET FECHA_BAJA=B.FECHA_BAJA
FROM 
#JAS_BASE_SERVICIOS_LUNA A
JOIN #JAS_LUNA_SERVICIO_AMDOCS B ON A.COD_CLIENTE=B.COD_CLIENTE AND A.COD_CUENTA=B.COD_CUENTA AND A.COD_SERVICIO=B.COD_SERVICIO
WHERE A.COD_SISTEMA=4

------ ELIMINANDO TEMPORALES ---

--DROP TABLE #JAS_LUNA_SERVICIO_ATIS
--DROP TABLE #JAS_LUNA_SERVICIO_STC
--DROP TABLE #JAS_LUNA_SERVICIO_AMDOCS

---- MARCANDO FLG DEUDA 
ALTER TABLE #JAS_BASE_SERVICIOS_LUNA ADD FLAG_DEUDA TINYINT
	UPDATE A
	SET A.FLAG_DEUDA = 1
	FROM #JAS_BASE_SERVICIOS_LUNA AS A
	INNER JOIN LUNA.TRAN_DEUDA AS B
	ON (A.COD_SISTEMA = B.COD_SISTEMA AND A.COD_CLIENTE = B.COD_CLIENTE AND A.COD_CUENTA = B.COD_CUENTA)
	WHERE B.FLAG_ACTIVO = 1

--- MARCANDO LOS CARIBU ----

--- STC ---
DROP TABLE #JAS_BASE_CARIBU
SELECT DISTINCT X.* INTO #JAS_BASE_CARIBU FROM (
SELECT 3 COD_SISTEMA,B.TCCCLI COD_CLIENTE,B.TCNFOL COD_CUENTA
FROM COBRA.STC.PLANTA_CUENTA B
WHERE (TCCPRO + TCCLIP + TCCTSE + TCTICO IN ('VRMF'))
UNION
SELECT 4 COD_SISTEMA,B.COD_CLIENTE,B.COD_CUENTA
FROM 
AMDOCS.PLANTA_SERVICIO B
WHERE ltrim(rtrim(UPPER(B.TIPO_LINEA)))='CARIBU'
) X

--- MARCANDO CARIBU  ---

ALTER TABLE #JAS_BASE_SERVICIOS_LUNA ADD FLAG_CARIBU TINYINT 

UPDATE #JAS_BASE_SERVICIOS_LUNA
SET FLAG_CARIBU=1
FROM #JAS_BASE_SERVICIOS_LUNA A
JOIN #JAS_BASE_CARIBU B
ON A.COD_SISTEMA=B.COD_SISTEMA AND A.COD_CLIENTE=b.COD_CLIENTE and a.COD_CUENTA=b.COD_CUENTA
where FLAG_CARIBU is null

DROP TABLE #JAS_BASE_CARIBU


UPDATE #JAS_BASE_SERVICIOS_LUNA
SET FLAG_CARIBU=2
FROM #JAS_BASE_SERVICIOS_LUNA A
JOIN COBRA.DBO.jas_FullStack_Mov_Sal_Mae_Caribu_Flag_Collection B
ON a.COD_CUENTA=cast(b.CUENTA_FINANCIERA as bigint)
where a.COD_SISTEMA=4 and a.FLAG_CARIBU is null and b.CARIBU_FLAG='Y'

ALTER TABLE #JAS_BASE_SERVICIOS_LUNA ADD MARCA_FECHA_BAJA TINYINT


UPDATE #JAS_BASE_SERVICIOS_LUNA
SET MARCA_FECHA_BAJA=
CASE 
	WHEN COD_ESTADO<30 THEN 0 ---- ACTIVOS 
	WHEN COD_ESTADO=30 AND FECHA_BAJA IS NULL THEN 1  ---- FECHAS BAJAS NULOS 
	WHEN COD_ESTADO=30 AND FECHA_BAJA BETWEEN DATEADD(MONTH,-6,CAST(LEFT(CAST(GETDATE() AS DATE),7)+'-01' AS DATE)) AND CAST(GETDATE() AS DATE) THEN  6  ---- FECHAS BAJAS 6M
	WHEN COD_ESTADO=30 AND FECHA_BAJA BETWEEN DATEADD(MONTH,-12,CAST(LEFT(CAST(GETDATE() AS DATE),7)+'-01' AS DATE)) AND CAST(GETDATE() AS DATE) THEN  12  ---- FECHAS BAJAS 12
	WHEN COD_ESTADO=30 AND FECHA_BAJA < DATEADD(MONTH,-12,CAST(LEFT(CAST(GETDATE() AS DATE),7)+'-01' AS DATE)) THEN  20  ---- FECHAS BAJAS MAYORES A 12 M
	ELSE 100
END


/********************************** OBTIENE LOS QUE SE MANTIENEN CON GESTION *****************************************************
SELECT COUNT(DISTINCT COD_LUNA) CTD_LUNA FROM #JAS_BASE_SERVICIOS_LUNAX
WHERE MARCA_FECHA_BAJA=0 OR (MARCA_FECHA_BAJA BETWEEN 1 AND 12 AND FLAG_DEUDA=1)  --- BASE FINAL A DISTRIBUIR ---
*******************************************************************************************************************************/

--- ALTER TABLE COBRA.LUNA.MASTER_LUNA ADD 	[FLAG_GESTION] [bit]
--- ALTER TABLE COBRA.LUNA.MASTER_CLIENTE ADD 	[FLAG_GESTION] [bit]
--- ALTER TABLE COBRA.LUNA.MASTER_CUENTA ADD 	[FLAG_GESTION] [bit]

--- ACTUALIZANDO FLAG_GESTION EN CUENTA
	UPDATE A
	SET A.FLAG_GESTION = 0
	FROM LUNA.MASTER_CUENTA AS A
	WHERE A.FLAG_GESTION IS NULL OR A.FLAG_GESTION <> 0

DROP TABLE #JAS_BASE_GESTION_CUENTA
SELECT DISTINCT COD_SISTEMA,COD_CLIENTE,COD_CUENTA INTO #JAS_BASE_GESTION_CUENTA FROM #JAS_BASE_SERVICIOS_LUNA
WHERE MARCA_FECHA_BAJA=0 OR (MARCA_FECHA_BAJA BETWEEN 1 AND 12 AND FLAG_DEUDA=1)  --- BASE FINAL A DISTRIBUIR ---

	UPDATE A
	SET A.FLAG_GESTION = 1
	FROM LUNA.MASTER_CUENTA AS A
	INNER JOIN #JAS_BASE_GESTION_CUENTA AS B
	ON (A.COD_SISTEMA = B.COD_SISTEMA AND A.COD_CLIENTE = B.COD_CLIENTE AND A.COD_CUENTA = B.COD_CUENTA)

DROP TABLE #JAS_BASE_GESTION_CUENTA


--- ACTUALIZANDO FLAG_GESTION EN CLIENTE
	UPDATE A
	SET A.FLAG_GESTION = 0
	FROM LUNA.MASTER_CLIENTE AS A
	WHERE A.FLAG_GESTION IS NULL OR A.FLAG_GESTION <> 0

DROP TABLE #JAS_BASE_GESTION_CLIENTE
SELECT DISTINCT COD_SISTEMA,COD_CLIENTE INTO #JAS_BASE_GESTION_CLIENTE FROM #JAS_BASE_SERVICIOS_LUNA
WHERE MARCA_FECHA_BAJA=0 OR (MARCA_FECHA_BAJA BETWEEN 1 AND 12 AND FLAG_DEUDA=1)  --- BASE FINAL A DISTRIBUIR ---

	UPDATE A
	SET A.FLAG_GESTION = 1
	FROM LUNA.MASTER_CLIENTE AS A
	INNER JOIN #JAS_BASE_GESTION_CLIENTE AS B
	ON (A.COD_SISTEMA = B.COD_SISTEMA AND A.COD_CLIENTE = B.COD_CLIENTE)

DROP TABLE #JAS_BASE_GESTION_CLIENTE



--- ACTUALIZANDO FLAG_GESTION EN LUNA
	UPDATE A
	SET A.FLAG_GESTION = 0
	FROM LUNA.MASTER_LUNA AS A
	WHERE A.FLAG_GESTION IS NULL OR A.FLAG_GESTION <> 0

DROP TABLE #JAS_BASE_GESTION_LUNA
SELECT DISTINCT COD_LUNA INTO #JAS_BASE_GESTION_LUNA FROM #JAS_BASE_SERVICIOS_LUNA
WHERE MARCA_FECHA_BAJA=0 OR (MARCA_FECHA_BAJA BETWEEN 1 AND 12 AND FLAG_DEUDA=1)  --- BASE FINAL A DISTRIBUIR ---

	UPDATE A
	SET A.FLAG_GESTION = 1
	FROM LUNA.MASTER_LUNA AS A
	INNER JOIN #JAS_BASE_GESTION_LUNA AS B
	ON (A.COD_LUNA = B.COD_LUNA)

DROP TABLE #JAS_BASE_GESTION_LUNA

------------------------- IDENTIFICANDO LAS ALTAS PURAS ---------
---SELECT DATEADD(MONTH,-4,CAST(LEFT(CAST(GETDATE() AS DATE),7)+'-01' AS DATE)) ,CAST(GETDATE() AS DATE)
DROP TABLE #JAS_LUNAS_ATENTO
SELECT COD_LUNA,COUNT(1) CTD_SERVICIOS_ACTIVOS,
SUM
(
CASE WHEN FECHA_ALTA BETWEEN DATEADD(MONTH,-4,CAST(LEFT(CAST(GETDATE() AS DATE),7)+'-01' AS DATE)) AND CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END
) CTD_ALTAS_4M
INTO #JAS_LUNAS_ATENTO
FROM #JAS_BASE_SERVICIOS_LUNA
WHERE COD_ESTADO<30
GROUP BY COD_LUNA
HAVING COUNT(1)=SUM
(
CASE WHEN FECHA_ALTA BETWEEN DATEADD(MONTH,-4,CAST(LEFT(CAST(GETDATE() AS DATE),7)+'-01' AS DATE)) AND CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END
) 


ALTER TABLE #JAS_BASE_SERVICIOS_LUNA ADD MARCA_BASE_ATENTO TINYINT

UPDATE #JAS_BASE_SERVICIOS_LUNA
SET MARCA_BASE_ATENTO=1
FROM #JAS_BASE_SERVICIOS_LUNA A
JOIN #JAS_LUNAS_ATENTO B ON A.COD_LUNA=B.COD_LUNA 

DROP TABLE #JAS_LUNAS_ATENTO

---- BASE OPERACIONES ---
DROP TABLE #JAS_LUNAS_OPERACIONES
SELECT COD_LUNA,COUNT(1) CTD_SERVICIOS,
SUM
(
CASE WHEN FLAG_CARIBU=1 THEN 1 ELSE 0 END
) CTD_CARIBUS
INTO #JAS_LUNAS_OPERACIONES
FROM #JAS_BASE_SERVICIOS_LUNA
WHERE MARCA_FECHA_BAJA=0 OR (MARCA_FECHA_BAJA BETWEEN 1 AND 12 AND FLAG_DEUDA=1) 
GROUP BY COD_LUNA
HAVING COUNT(1)=SUM
(
CASE WHEN FLAG_CARIBU=1 THEN 1 ELSE 0 END
) 

ALTER TABLE #JAS_BASE_SERVICIOS_LUNA ADD MARCA_BASE_CARIBU TINYINT

UPDATE #JAS_BASE_SERVICIOS_LUNA
SET MARCA_BASE_CARIBU=1
FROM #JAS_BASE_SERVICIOS_LUNA A
JOIN #JAS_LUNAS_OPERACIONES B ON A.COD_LUNA=B.COD_LUNA 

ALTER TABLE #JAS_BASE_SERVICIOS_LUNA ADD COD_COMPORTAMIENTO_MERCADO TINYINT

UPDATE #JAS_BASE_SERVICIOS_LUNA
SET COD_COMPORTAMIENTO_MERCADO=B.COD_COMPORTAMIENTO_MERCADO
FROM 
#JAS_BASE_SERVICIOS_LUNA A
JOIN COBRA.LUNA.DATA_VARIABLES_RIESGOS_DET_FIJA_F B
ON A.COD_LUNA=B.COD_LUNA WHERE A.COD_COMPORTAMIENTO_MERCADO IS NULL

UPDATE #JAS_BASE_SERVICIOS_LUNA
SET COD_COMPORTAMIENTO_MERCADO=B.COD_COMPORTAMIENTO_MERCADO
FROM 
#JAS_BASE_SERVICIOS_LUNA A
JOIN COBRA.LUNA.DATA_VARIABLES_RIESGOS_DET_MOVIL_F B
ON A.COD_LUNA=B.COD_LUNA WHERE A.COD_COMPORTAMIENTO_MERCADO IS NULL


--------------------------AÑADIR MOVISTAR TOTAL-----------------------

ALTER TABLE #JAS_BASE_SERVICIOS_LUNA ADD MARCA_MT TINYINT

select * INTO #TEMP_MT from GPPESPLCLI1212.COBRANZA_PROD.DBO.jmp_planta_movistar_total  ---
where ESTADO_CONVERGENTE='TERMINADO'
and TIPO_INPUT='1' --- 1= PLANTA BI   
--- CRUZAR COD_SISTEMA Y COD_CUENTA.

--SELECT * FROM #TEMP_MT
--SELECT * FROM #JAS_BASE_SERVICIOS_LUNAX

UPDATE #JAS_BASE_SERVICIOS_LUNA
SET MARCA_MT=1
FROM #JAS_BASE_SERVICIOS_LUNA A
JOIN #TEMP_MT B 
ON A.COD_CUENTA=B.COD_CUENTA AND A.COD_SISTEMA=1  

UPDATE #JAS_BASE_SERVICIOS_LUNA
SET MARCA_MT=1
FROM #JAS_BASE_SERVICIOS_LUNA A
JOIN #TEMP_MT B 
ON A.COD_CUENTA=B.FINANCIAL_ACCOUNT AND A.COD_SISTEMA=4 


--SELECT * FROM #JAS_BASE_SERVICIOS_LUNAX


--------------------------AÑADIR FINANCIAMIENTO------------------------

ALTER TABLE #JAS_BASE_SERVICIOS_LUNA ADD MARCA_FINAN TINYINT

SELECT TELEFONO,FINANCIAL_ACCOUNT_KEY,SISTEMA,FECHA_VCTO INTO #TEMP_FINAN 
 FROM GPPESPLCLI1005.COBRA.DBO.JMP_BASE_MARCA_TIPO_GESTION 
WHERE TIPO_GESTION = 'SMS_FINANCIAMIENTO' 
AND DATEDIFF(DAY,FECHA_VCTO,GETDATE())<=95

--SELECT * FROM #TEMP_FINAN

UPDATE  #JAS_BASE_SERVICIOS_LUNA
SET MARCA_FINAN=1
FROM #JAS_BASE_SERVICIOS_LUNA A
JOIN #TEMP_FINAN  B 
ON A.COD_cuenta=B.FINANCIAL_ACCOUNT_KEY AND A.COD_SISTEMA=4 
   

-------  FIN DE TABLON  ---- 
DROP TABLE SRMS.DBO.JAS_BASE_SERVICIOS_LUNA_ASIGNACION
SELECT *  INTO SRMS.DBO.JAS_BASE_SERVICIOS_LUNA_ASIGNACION FROM #JAS_BASE_SERVICIOS_LUNA


/****************************************************************************************************************************************/
PRINT 'HORA FIN: ' + cast(cast(getdate() as dateTIME) as varchar(20))
PRINT '\**********  FIN DE SCRIPT 05_GENERANDO_TABLON_ASIGNACION  **********/'
/****************************************************************************************************************************************/